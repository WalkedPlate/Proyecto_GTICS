   <!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Farmacias Clínica Renacer</title>
        <link rel="shortcut icon" href="/img/FarmaciaWebVenta/logo/icono.png" type="image/x-icon">

        <!--
  - favicon
-->
        <link rel="shortcut icon" href="/img/FarmaciaWebVenta/logo/icono.png" type="image/x-icon">

        <!--
          - custom css link
        -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
              integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
              crossorigin="anonymous">
        <link rel="stylesheet" href="/css/FarmaciaWebVenta/style-prefix.css">
        <link rel="stylesheet" href="/css/FarmaciaWebVenta/style.css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pixeden-stroke-7-icon@1.2.3/pe-icon-7-stroke/dist/pe-icon-7-stroke.min.css">


        <!--
          - google font link
        -->
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&display=swap"
              rel="stylesheet">
        <link rel="stylesheet"
              href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"/>

        <style>
            .table-responsive {
                border-radius: 15px;
                overflow: hidden;
            }

            table {
                width: 100%;
                border-collapse: collapse;
                border-radius: 15px;
                overflow: hidden;
            }

            th, td {
                text-align: center;
                vertical-align: middle;
                padding: 8px;
                border: 1px solid #dee2e6; /* Asegura que las líneas del borde sean visibles */
            }

            th {
                font-size: 14px;
            }

            .table-primary th {
                background-color: #cfe2ff;
                border-bottom: 2px solid #dee2e6;
            }

            .card-header {
                border-radius: 15px 15px 0 0;
            }

            img.avatar-sm {
                width: 40px;
                height: 40px;
                object-fit: cover;
            }
        </style>

    </head>

    <body>
        <!-- HEADER -->

        <header th:replace="~{FarmaciaWebVenta/fragments_clinicaweb/cabecera.html :: cabecera}"></header>


        <!-- MAIN -->

        <main class="pb-5">

            <br>

            <!--
                        - Carrito de compras
                        -->

            <div class="product-featured invoice-box pb-3">

                <div class="col-12 mb-4 mb-sm-0" style="display: flex">
                    <h5 class="mb-0 ls-tight" style="padding-right: 8px">
                        <a th:href="@{'/clinicarenacer/historialPedidos'}">
                            Historial de pedidos</a>
                    </h5>
                    <h5 th:text="'< Orden N° ' +${ordenActual.codigo}" class="text-success"> </h5>
                </div>

                <div class="invoice-box mb-3" >
                    <table cellpadding="0" cellspacing="0">
                        <tr class="top">
                            <td colspan="2">
                                <table>
                                    <tr>
                                        <td class="title">
                                            <div style="display: flex;
                                                align-items: center;">
                                                <img src="/img/FarmaciaWebVenta/logo/icono.png" style="width: 50px;
                                                    margin-right: 0.3rem;" alt="renacer">
                                                <div>
                                                    <h3 style="color:#2973e9; font-size: 1.5rem; font-weight: bold">
                                                        <span class="text-dark" style="padding-left: 5px; padding-right: 5px">Clínica</span>Renacer
                                                    </h3>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <div>Factura: #100</div>
                                            <div th:text="'Fecha de registro: ' + ${ordenActual.fechaRegistro}"></div>
                                            <div th:text="'Fecha de entrega: ' + ${ordenActual.fechaEntrega}"></div>
                                        </td>
                                    </tr>
                                </table>
                            </td>
                        </tr>

                        <tr class="information">
                            <td colspan="2">
                                <table>
                                    <tr>
                                        <td>
                                            Sistema Web S.A. de C.V.<br>
                                            234/90, New York Street<br>
                                            United States
                                        </td>

                                        <td>
                                            [Nombre cliente]<br>
                                            [Nombre empresa]<br>
                                            [Dirección empresa]
                                        </td>
                                    </tr>
                                </table>
                            </td>
                        </tr>

                        <tr class="heading">
                            <td>
                                Vendedor
                            </td>

                            <td>
                                Orden de compra
                            </td>
                        </tr>

                        <tr class="details">
                            <td>
                                John Doe
                            </td>

                            <td>
                                #PO-2020
                            </td>
                        </tr>

                        <tr class="heading">
                            <td>
                                Código
                            </td>

                            <td>
                                Precio
                            </td>
                        </tr>

                        <tr class="item">
                            <td>
                                12345
                            </td>

                            <td>
                                $99.00
                            </td>
                        </tr>

                        <tr class="total">
                            <td></td>

                            <td>
                                Total: $99.00
                            </td>
                        </tr>
                    </table>
                </div>

                <div class="showcase-wrapper has-scrollbar">
                    <div class="showcase-container">
                        <div class="card-header text-center" style="background: #373a93">
                            <h4 class="mb-0 p-2 ls-tight" style="color: white">Medicamentos
                                solicitados</h4>

                        </div>
                        <hr>
                        <div class="container">
                            <div class="table-responsive">
                                <form action="" class="form-cart">
                                    <div class="item">
                                        <table class="table table-bordered" id="cart-table">
                                            <thead class="table-primary">
                                            <tr>
                                                <th>#</th>
                                                <th>Imagen</th>
                                                <th>Nombre Producto</th>
                                                <th>Cantidad</th>
                                                <th>Monto Parcial (S/.)</th>
                                            </tr>
                                            </thead>
                                            <tbody>
                                            <tr th:each="detalle, obj : ${listaDetalles}">
                                                <td class="text-center" th:text="${obj.index + 1}"></td>
                                                <td class="text-center" >
                                                    <div class="d-flex justify-content-center">
                                                        <img alt="..." class="avatar avatar-sm rounded-circle " width="60" th:src="@{|/imageProduct/${detalle.productos.idProductos}|}">
                                                    </div>
                                                </td>
                                                <td class="text-center" th:text="${detalle.productos.nombre}"></td>
                                                <td class="text-center" th:text="${detalle.cantidad}"></td>
                                                <td class="text-center" th:text="${detalle.montoParcial}"></td>
                                            </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card shadow border-0 mt-2 mb-2">
                    <div
                            class="card-header text-center" style="background: #272b31">
                        <h4 th:if="${ordenActual.estadoOrden.idEstadoOrden == 1}" class="mb-0 ls-tight" style="color: white">Esta orden aún no ha sido aprobada </h4>
                        <h4 th:if="${ordenActual.estadoOrden.idEstadoOrden == 2}" class="mb-0 ls-tight" style="color: white">Esta orden ha sido eliminada</h4>
                        <h4 th:if="${ordenActual.estadoOrden.idEstadoOrden == 3}" class="mb-0 ls-tight" style="color: white">Esta orden ha sido rechazada por un superadmin</h4>
                        <h4 th:if="${ordenActual.estadoOrden.idEstadoOrden != 3 and
                                                  ordenActual.estadoOrden.idEstadoOrden != 2 and
                                                  ordenActual.estadoOrden.idEstadoOrden != 1}"
                            class="mb-0 ls-tight" style="color: white">Estado de envío</h4>
                    </div>
                    <div th:if="${ordenActual.estadoOrden.idEstadoOrden != 3 and
                                                  ordenActual.estadoOrden.idEstadoOrden != 2 and
                                                  ordenActual.estadoOrden.idEstadoOrden != 1}" class="card-body">
                        <div class="steps d-flex flex-wrap flex-sm-nowrap justify-content-between padding-top-2x padding-bottom-1x">


                            <div class="step completed">
                                <div class="step-icon-wrap">
                                    <div class="step-icon"><i class="pe-7s-cart"></i></div>
                                </div>
                                <h4 class="step-title" >Recibido</h4>
                            </div>
                            <div th:class="'step' + (${ordenActual.estadoOrden.idEstadoOrden == 7 or ordenActual.estadoOrden.idEstadoOrden == 6 or
                                                                        ordenActual.estadoOrden.idEstadoOrden == 5 or ordenActual.estadoOrden.idEstadoOrden == 10} ? ' completed' : '')">
                                <div class="step-icon-wrap">
                                    <div class="step-icon"><i class="pe-7s-config"></i></div>
                                </div>
                                <h4 class="step-title">En Proceso</h4>
                            </div>
                            <div th:class="'step' + (${ordenActual.estadoOrden.idEstadoOrden == 6 or
                                                                        ordenActual.estadoOrden.idEstadoOrden == 5 or ordenActual.estadoOrden.idEstadoOrden == 10} ? ' completed' : '')">
                                <div class="step-icon-wrap">
                                    <div class="step-icon"><i class="pe-7s-medal"></i></div>
                                </div>
                                <h4 class="step-title">Empaquetado</h4>
                            </div>
                            <div th:class="'step' + (${ordenActual.estadoOrden.idEstadoOrden == 5 or ordenActual.estadoOrden.idEstadoOrden == 10} ? ' completed' : '')">
                                <div class="step-icon-wrap">
                                    <div class="step-icon"><i class="pe-7s-car"></i></div>
                                </div>
                                <h4 class="step-title">En ruta</h4>
                            </div>
                            <div th:class="'step' + (${ordenActual.estadoOrden.idEstadoOrden == 10} ? ' completed' : '')">
                                <div class="step-icon-wrap">
                                    <div class="step-icon"><i class="pe-7s-home"></i></div>
                                </div>
                                <h4 class="step-title">Entregado</h4>
                            </div>
                        </div>
                        <div id="map" class="map-container" style="width: 100%; height: 400px;">

                        </div>
                    </div>
                </div>
            </div>
        </main>

        <footer th:replace="~{FarmaciaWebVenta/fragments_clinicaweb/footer.html :: footer}">
        </footer>

        <!-- custom js link -->
        <script src="/js/FarmaciaWebVenta/script.js"></script>

        <!-- ionicon link -->
        <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
        <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>

        <script src="https://code.jquery.com/jquery-3.7.1.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
        <script src="/js/Superadmin/table.js"></script>
        <script src="https://cdn.datatables.net/2.0.5/js/dataTables.bootstrap5.js"></script>

        <!-- Mapa -->

        <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCXl59fxmrrijMF3f6ActbwkX4qLwOzdnE&callback=initMap" async defer></script>
        <script th:inline="javascript">
            let map, marker, deliveryMarker, directionsService, directionsRenderer;
            let ordenId = [[${ordenActual.idordenes}]];
            let estadoOrden = [[${ordenActual.estadoOrden.idEstadoOrden}]];
            //let ubicacionEntrega = [[${ordenActual.direccion}]];
            estadoOrden = parseInt(estadoOrden);
            //if(ubicacionEntrega === 'Recojo en farmacia'){
                //ubicacionEntrega = 'PUCP, Lima, Perú';
            //}

            function initMap() {
                const defaultLocation = { lat: -12.04529, lng: -77.03051 }; //
                const entregaIcon = {
                    url: '/img/Maps/place.webp',
                    scaledSize: new google.maps.Size(40, 40) // Tamaño ajustado del ícono
                };
                let pedidoIcon = {
                    url: '/img/Maps/preparando.png',
                    scaledSize: new google.maps.Size(40, 40) // Tamaño ajustado del ícono
                };

                if(estadoOrden === 5 || estadoOrden === 10){
                    pedidoIcon = {
                        url: '/img/Maps/delivery.png',
                        scaledSize: new google.maps.Size(40, 40) // Tamaño ajustado del ícono
                    };
                }

                map = new google.maps.Map(document.getElementById('map'), {
                    zoom: 15,
                    center: defaultLocation
                });

                marker = new google.maps.Marker({
                    position: defaultLocation,
                    map: map,
                    title: 'Ubicación actual del pedido',
                    icon: pedidoIcon
                });

                deliveryMarker = new google.maps.Marker({
                    map: map,
                    title: 'Ubicación de la entrega',
                    icon: entregaIcon
                });

                directionsService = new google.maps.DirectionsService();
                directionsRenderer = new google.maps.DirectionsRenderer({
                    map: map,
                    suppressMarkers: true // Usaremos nuestros propios marcadores
                });

                // Llamada inicial para obtener las coordenadas de la ubicación de entrega
                fetchCoordinates('PUCP, Lima, Perú');

                // Llamada inicial para obtener la ubicación del pedido
                fetchUbicacion(true);
            }

            function fetchCoordinates(address) {
                fetch(`/maps/geocode?address=${encodeURIComponent(address)}`)
                    .then(response => response.json())
                    .then(data => {
                        const location = data.results[0].geometry.location;
                        deliveryMarker.setPosition(location);
                        deliveryMarker.setTitle('Ubicación de la entrega');
                        calculateAndDisplayRoute(location);
                    })
                    .catch(error => console.error('Error:', error));
            }

            function fetchUbicacion(isInitial = false) {
                fetch(`/maps/ubicacion/${ordenId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.latitud && data.longitud) {
                            const newPos = { lat: data.latitud, lng: data.longitud };
                            marker.setPosition(newPos);
                            marker.setTitle('Ubicación actual del pedido');
                            calculateAndDisplayRoute(deliveryMarker.getPosition());
                        } else if (isInitial) {
                            const defaultPos = { lat: -12.04529, lng: -77.03051 }; // Ubicación predeterminada
                            marker.setPosition(defaultPos);
                            marker.setTitle('Ubicación predeterminada del pedido');
                            calculateAndDisplayRoute(deliveryMarker.getPosition());
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching location:', error);
                        if (isInitial) {
                            const defaultPos = { lat: -12.04529, lng: -77.03051 }; // Ubicación predeterminada
                            marker.setPosition(defaultPos);
                            marker.setTitle('Ubicación predeterminada del pedido');
                            calculateAndDisplayRoute(deliveryMarker.getPosition());
                        }
                    });

                setTimeout(fetchUbicacion, 10000); // Actualizar cada 10 segundos
            }

            function calculateAndDisplayRoute(destination) {
                const request = {
                    origin: marker.getPosition(),
                    destination: destination,
                    travelMode: 'DRIVING'
                };

                directionsService.route(request, (result, status) => {
                    if (status === 'OK') {
                        directionsRenderer.setDirections(result);
                        const bounds = new google.maps.LatLngBounds();
                        bounds.extend(marker.getPosition());
                        bounds.extend(deliveryMarker.getPosition());
                        map.fitBounds(bounds);
                    } else {
                        console.error('Directions request failed due to ' + status);
                    }
                });
            }
        </script>


    </body>

</html>